<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½³è…¾å›½é™…éƒ‘å·-FedExå°¾ç¨‹æ‰¹é‡æµ‹ç®—ç³»ç»Ÿ (è´¹ç‡æ›´æ–°ç‰ˆ)</title>
    <style>
        :root {
            --primary: #4d148c; /* FedEx Purple */
            --secondary: #ff6200; /* FedEx Orange */
            --bg: #f4f6f8;
            --card-bg: #ffffff;
            --text: #333;
            --border: #ddd;
            --badge-gray: #e0e0e0;
        }
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        
        /* Login Overlay */
        #loginOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f4f6f8;
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(77, 20, 140, 0.15);
            text-align: center;
            width: 90%;
            max-width: 400px;
            border-top: 5px solid var(--primary);
        }
        .login-box h2 { color: var(--primary); margin-bottom: 20px; }
        .login-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #eee;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            text-align: center;
            letter-spacing: 2px;
        }
        .login-input:focus { border-color: var(--secondary); outline: none; }
        
        /* Sticky Header */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(244, 246, 248, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-bottom: 3px solid var(--secondary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sticky-header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px 40px 20px; position: relative; z-index: 1; display: none; /* Hidden by default */ }
        
        /* Watermark */
        .watermark-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; overflow: hidden; display: none; }
        .watermark { 
            position: absolute; 
            font-size: 4rem; 
            font-weight: 900; 
            color: rgba(0, 0, 0, 0.3); 
            white-space: nowrap; 
            user-select: none; 
            text-transform: uppercase; 
            font-family: "Microsoft YaHei", sans-serif; 
        }
        @keyframes floatDiagonal1 { 0% { transform: translate(-10%, -10%) rotate(-30deg); opacity: 0.1; } 50% { transform: translate(80vw, 80vh) rotate(-30deg); opacity: 0.3; } 100% { transform: translate(-10%, -10%) rotate(-30deg); opacity: 0.1; } }
        @keyframes floatDiagonal2 { 0% { transform: translate(80vw, -10%) rotate(-30deg); opacity: 0.1; } 50% { transform: translate(-10%, 80vh) rotate(-30deg); opacity: 0.3; } 100% { transform: translate(80vw, -10%) rotate(-30deg); opacity: 0.1; } }
        .wm-1 { top: 0; left: 0; animation: floatDiagonal1 25s infinite ease-in-out; }
        .wm-2 { top: 0; right: 0; animation: floatDiagonal2 32s infinite ease-in-out; }

        /* UI Components */
        .panel { background: var(--card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid white; }
        h3 { margin-top: 0; color: #444; border-left: 4px solid var(--primary); padding-left: 10px; }
        
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: bold; margin-bottom: 6px; color: #666; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: 0.2s; }
        input:focus { outline: none; border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(255, 98, 0, 0.1); }
        
        .btn { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn:hover { background: #3b0f6b; transform: translateY(-1px); }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-export { background: #28a745; padding: 8px 16px; font-size: 13px; margin-left: 10px; }
        
        /* Settings Areas */
        .settings-toggle { cursor: pointer; color: var(--secondary); font-weight: bold; margin: 15px 0 5px; display: inline-flex; align-items: center; font-size: 14px; user-select: none; }
        .settings-toggle:hover { text-decoration: underline; }
        #settingsPanel, #rateConfigPanel { display: none; background: #fffcf9; border: 1px dashed #ffdcc2; padding: 20px; border-radius: 8px; margin-top: 10px; }
        .config-area { width: 100%; height: 120px; font-family: monospace; border: 1px solid #eee; background: white; white-space: pre; overflow-y: scroll; padding: 10px; }

        /* Results Display */
        .info-bar { 
            background: #eef2f5; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            font-size: 0.95em; 
            color: #444; 
            border-left: 4px solid #999;
            /* display: grid; Removed Grid to use Block/Flex for horizontal layout */
            display: block; 
        }
        .weight-box { background: white; padding: 8px; border-radius: 4px; text-align: center; border: 1px solid #ddd; }
        .weight-box strong { display: block; font-size: 1.2em; color: var(--primary); }
        .weight-box span { font-size: 0.8em; color: #888; text-transform: uppercase; }

        .results-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .result-card { background: white; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); overflow: hidden; transition: transform 0.2s; }
        .result-card:hover { transform: translateY(-2px); }
        .result-header { background: var(--primary); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1em; letter-spacing: 0.5px; }
        .result-card:nth-child(2) .result-header { background: #380d6b; } 
        .result-card:nth-child(3) .result-header { background: var(--secondary); }
        
        .result-body { padding: 20px; }
        .total-price { text-align: center; color: var(--primary); font-size: 2.2em; font-weight: 800; margin: 15px 0 25px; }
        .detail-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #eee; }
        .detail-row:last-child { border-bottom: none; }
        .detail-row.fuel-row { color: #888; font-style: italic; font-size: 0.85em; }
        
        /* Badges & Icons */
        .badge { display: inline-flex; align-items: center; padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; text-transform: uppercase; margin-right: 6px; line-height: 1; }
        .badge-fedex { background: #eaddff; color: var(--primary); border: 1px solid rgba(77, 20, 140, 0.2); }
        .badge-org { background: #ffeacc; color: var(--secondary); border: 1px solid rgba(255, 98, 0, 0.2); }
        .badge-red { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
        .badge-fuel { background: #f5f5f5; color: #757575; }

        /* Batch Table */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; margin-top: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 700; border-bottom: 2px solid #eee; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #fcfcfc; }

        @media (max-width: 768px) { 
            .results-container { grid-template-columns: 1fr; } 
            .sticky-header h1 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>ç³»ç»Ÿé”å®š</h2>
        <p style="color:#666; margin-bottom:20px;">è¯·è¾“å…¥å¯†ç è®¿é—®ç³»ç»Ÿ</p>
        <input type="password" id="sysPassword" class="login-input" placeholder="PASSWORD" onkeyup="checkEnter(event)">
        <button class="btn" onclick="checkLogin()" style="width:100%">è§£é”ç³»ç»Ÿ</button>
        <p id="loginError" style="color:red; margin-top:10px; display:none; font-size:12px;">âŒ å¯†ç é”™è¯¯</p>
    </div>
</div>

<div class="watermark-container" id="watermark">
    <div class="watermark wm-1">ä½³è…¾å›½é™…</div>
    <div class="watermark wm-2">ä½³è…¾å›½é™…</div>
</div>

<div class="sticky-header">
    <h1>ä½³è…¾å›½é™…éƒ‘å· - FedEx å°¾ç¨‹æµ‹ç®—ç³»ç»Ÿ</h1>
</div>

<div class="container" id="mainContainer">
    <div class="panel">
        <h3>1. åŸºç¡€é…ç½® (Global Settings)</h3>
        <div class="grid-form">
            <div class="form-group"><label>æµ‹ç®—æ—¥æœŸ (é»˜è®¤ä»Šå¤©)</label><input type="date" id="calcDate"></div>
            <div class="form-group"><label>åœ°å€ç±»å‹</label>
                <select id="addrType">
                    <option value="residential">ä½å®… (Residential)</option>
                    <option value="commercial">å•†ä¸š (Commercial)</option>
                </select>
            </div>
            <div class="form-group"><label>ç‡ƒæ²¹é™„åŠ è´¹ç‡ (%)</label><input type="number" id="fuelRate" value="16.5" step="0.1"></div>
            <div class="form-group"><label>ç‡ƒæ²¹æŠ˜æ‰£ (0.75 = 75æŠ˜)</label><input type="number" id="fuelDiscount" value="0.75" step="0.01"></div>
        </div>
        
        <div class="settings-toggle" onclick="toggleRateConfig()"><span>ğŸ“ ä¿®æ”¹åŸºç¡€è¿è´¹è¡¨ (Zone 5/6)</span></div>
        <div id="rateConfigPanel">
            <p style="font-size:12px; color:#666; margin:0 0 5px;">âš ï¸ æç¤ºï¼šç³»ç»Ÿå·²å†…ç½®éƒ¨åˆ†æ›´æ–°çš„è´¹ç‡ã€‚å¦‚æœè®¡ç®—ç»“æœä¸å‡†ï¼Œè¯·å°†å®Œæ•´ CSV æ•°æ®ç²˜è´´äºæ­¤ã€‚</p>
            <textarea id="rateInput" class="config-area"></textarea>
            <div style="margin-top:10px;">
                <button class="btn" style="padding:6px 12px; font-size:12px;" onclick="saveCustomRates()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-warning" style="padding:6px 12px; font-size:12px;" onclick="resetDefaultRates()">â†º æ¢å¤é»˜è®¤</button>
            </div>
        </div>

        <div class="settings-toggle" onclick="toggleSettings()"><span>âš™ï¸ ä¿®æ”¹é™„åŠ è´¹å‚æ•°</span></div>
        <div id="settingsPanel">
            <div class="grid-form">
                <div class="form-group"><label>DIM (ä½“ç§¯ç³»æ•°)</label><input type="number" id="dimDivisor" value="250"></div>
                <div class="form-group"><label>ä½å®…è´¹ (Resi)</label><input type="number" id="feeResi" value="2.27"></div>
                <div class="form-group"><label>AHS - Dimension</label><input type="number" id="feeAHS_Dim" value="5.90"></div>
                <div class="form-group"><label>AHS - Weight</label><input type="number" id="feeAHS_Wgt" value="8.64"></div>
                <div class="form-group"><label>Oversize Charge</label><input type="number" id="feeOS" value="48.75"></div>
                <div class="form-group"><label>Unauthorized</label><input type="number" id="feeUnauthorized" value="1694.32"></div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>2. å•ä¸ªäº§å“å¿«é€Ÿæµ‹ç®—</h3>
        <div class="grid-form">
            <div class="form-group"><label>SKU</label><input type="text" id="singleSku" placeholder="A001"></div>
            <div class="form-group"><label>é•¿ (CM)</label><input type="number" id="lengthCm" placeholder="0"></div>
            <div class="form-group"><label>å®½ (CM)</label><input type="number" id="widthCm" placeholder="0"></div>
            <div class="form-group"><label>é«˜ (CM)</label><input type="number" id="heightCm" placeholder="0"></div>
            <div class="form-group"><label>å®é‡ (KG)</label><input type="number" id="weightKg" placeholder="0"></div>
        </div>
        <button class="btn" onclick="runSingleCalc()" style="width:100%; margin-top:20px; font-size:16px;">å¼€å§‹è®¡ç®—</button>
        
        <div id="calcInfo" style="display:none;" class="info-bar"></div>
        
        <div class="results-container" id="singleResults" style="display:none;">
            <div class="result-card">
                <div class="result-header">Zone 5</div>
                <div class="result-body">
                    <div class="total-price" id="totalZ5"></div>
                    <div id="detailsZ5"></div>
                </div>
            </div>
            <div class="result-card">
                <div class="result-header">Zone 6</div>
                <div class="result-body">
                    <div class="total-price" id="totalZ6"></div>
                    <div id="detailsZ6"></div>
                </div>
            </div>
            <div class="result-card">
                <div class="result-header">å¹³å‡è¿è´¹ (Avg)</div>
                <div class="result-body">
                    <div class="total-price" id="totalAvg"></div>
                    <div style="text-align:center; color:#888; font-size:0.9em; margin-top:10px;">(Zone5 + Zone6) / 2</div>
                </div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>3. æ‰¹é‡æµ‹ç®— <button class="btn btn-export" onclick="exportTableToCSV()">å¯¼å‡º Excel</button></h3>
        <textarea id="batchInput" class="config-area" style="height:150px; border:2px dashed #ddd;" placeholder="ç²˜è´´æ ¼å¼: SKU, é•¿, å®½, é«˜, å®é‡ (æ”¯æŒExcelç›´æ¥ç²˜è´´)"></textarea>
        <button class="btn" onclick="runBatchCalc()" style="margin-top:15px;">æ‰¹é‡è¿è¡Œ</button>
        <div style="overflow-x:auto;">
            <table id="batchResultsTable">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>å°ºå¯¸/å›´é•¿</th>
                        <th>è®¡è´¹é‡ (lb)</th>
                        <th>Zone 5</th>
                        <th>Zone 6</th>
                        <th>å¹³å‡</th>
                        <th>é™„åŠ è´¹æ˜ç»†</th>
                    </tr>
                </thead>
                <tbody id="batchTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- Login Logic ---
    function checkLogin() {
        const p = document.getElementById('sysPassword').value;
        if(p === 'JT8888') {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            document.getElementById('watermark').style.display = 'block';
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }
    function checkEnter(e) { if(e.key === 'Enter') checkLogin(); }

    // --- Core Data ---
    // Updated with high-precision data from uploaded CSV (Hybrid approach: 1-16 & 93-107 Updated, Rest are Legacy/Interpolated)
    const DEFAULT_RATES_CSV = `1,6.4015812,6.4125054
2,6.4015812,6.4125054
3,6.4015812,6.4125054
4,6.4015812,6.4125054
5,6.4015812,6.4125054
6,6.4015812,6.4125054
7,6.4015812,6.4125054
8,6.4015812,6.4125054
9,6.4015812,6.4780506
10,6.4015812,6.55452
11,6.4015812,6.4125054
12,6.4015812,6.4125054
13,6.4015812,6.4125054
14,6.4015812,6.4562022
15,6.4015812,6.8057766
16,6.4015812,7.0242606
17,6.40,7.33
18,6.47,7.71
19,6.77,7.93
20,7.05,8.20
21,7.12,8.47
22,7.32,8.80
23,7.46,9.14
24,7.85,9.57
25,8.01,9.85
26,8.34,10.21
27,8.48,10.62
28,8.97,11.14
29,8.98,11.46
30,9.33,11.65
31,9.45,11.98
32,9.45,11.98
33,9.90,12.74
34,10.24,12.74
35,10.49,12.96
36,10.75,13.50
37,10.98,13.57
38,11.25,13.87
39,11.59,14.50
40,11.60,14.52
41,12.01,15.12
42,12.05,15.20
43,12.66,16.01
44,12.89,16.11
45,12.89,16.11
46,13.14,16.54
47,13.23,16.77
48,13.71,17.01
49,13.71,17.14
50,13.72,17.29
51,12.14,15.40
52,12.14,15.40
53,12.26,15.40
54,12.28,15.41
55,12.28,15.41
56,12.29,15.42
57,12.65,15.42
58,12.66,15.42
59,12.66,15.53
60,13.11,15.82
61,13.14,15.83
62,13.51,16.07
63,13.52,16.18
64,13.52,16.30
65,13.52,16.44
66,13.52,16.45
67,13.56,16.57
68,13.86,16.82
69,13.96,16.91
70,14.64,17.25
71,14.64,17.36
72,14.64,17.64
73,14.86,17.84
74,14.86,18.11
75,14.98,18.11
76,15.21,18.52
77,15.27,18.63
78,15.44,18.74
79,15.69,19.13
80,16.06,19.45
81,16.17,19.70
82,16.57,19.75
83,16.58,19.81
84,16.74,20.30
85,17.01,20.42
86,17.33,20.85
87,17.33,21.13
88,17.89,21.21
89,17.95,21.67
90,18.47,21.98
91,18.47,21.98
92,18.66,22.25
93,18.6585336,22.2525954
94,18.898866,22.722336
95,19.1501226,22.7878812
96,19.3686066,22.7878812
97,19.6744842,23.2794702
98,19.9038924,23.541651
99,20.155149,23.596272
100,20.264391,23.8584528
101,20.4610266,24.087861
102,20.4610266,24.087861
103,20.5811928,24.142482
104,20.6030412,24.1534062
105,21.2257206,24.743313
106,21.2366448,24.7542372
107,21.46605,24.7542372
108,21.47,24.97
109,21.88,25.19
110,22.30,25.89
111,22.51,25.89
112,22.51,26.10
113,22.73,26.10
114,23.17,26.79
115,23.45,26.80
116,23.45,27.19
117,23.77,27.19
118,23.84,27.39
119,24.20,27.39
120,24.36,27.87
121,24.37,28.04
122,24.59,28.26
123,25.26,28.49
124,25.26,28.68
125,25.27,28.68
126,25.27,28.85
127,25.84,29.51
128,25.85,29.51
129,26.02,29.51
130,26.02,29.72
131,26.45,30.16
132,26.62,30.16
133,26.62,30.31
134,27.10,30.84
135,27.58,31.22
136,27.82,31.22
137,28.03,31.22
138,28.26,31.87
139,28.26,31.87
140,28.71,32.22
141,28.71,32.22
142,29.17,32.70
143,29.18,32.70
144,30.09,33.57
145,30.09,34.07
146,30.10,34.07
147,30.39,34.31
148,30.40,34.31
149,30.87,34.43
150,31.31,34.43`;

    let baseRates = {};

    function initSystem() {
        document.getElementById('calcDate').valueAsDate = new Date();
        const stored = localStorage.getItem('customRates');
        const data = stored ? stored : DEFAULT_RATES_CSV;
        document.getElementById('rateInput').value = data;
        parseRates(data);
    }

    function parseRates(csv) {
        baseRates = {};
        csv.trim().split('\n').forEach(line => {
            const p = line.split(/\t|,/);
            if(p.length>=3) {
                const w=parseInt(p[0]), z5=parseFloat(p[1]), z6=parseFloat(p[2]);
                if(!isNaN(w)) baseRates[w] = { z5:z5||0, z6:z6||0 };
            }
        });
    }

    function saveCustomRates() {
        const val = document.getElementById('rateInput').value;
        localStorage.setItem('customRates', val);
        parseRates(val);
        alert("ä¿å­˜æˆåŠŸï¼");
        document.getElementById('rateConfigPanel').style.display = 'none';
    }
    function resetDefaultRates() { if(confirm("æ¢å¤é»˜è®¤ï¼Ÿ")) { localStorage.removeItem('customRates'); document.getElementById('rateInput').value=DEFAULT_RATES_CSV; parseRates(DEFAULT_RATES_CSV); } }
    function toggleSettings() { const p=document.getElementById('settingsPanel'); p.style.display=p.style.display==='block'?'none':'block'; }
    function toggleRateConfig() { const p=document.getElementById('rateConfigPanel'); p.style.display=p.style.display==='block'?'none':'block'; }

    function getPeakSurcharges(dateStr) {
        const d = new Date(dateStr);
        const inRange = (s,e) => d>=new Date(s) && d<=new Date(e);
        let p = { ahs_dim:0, ahs_weight:0, oversize:0, residential:0 };
        // Peak Surcharge Schedule
        if (inRange('2025-09-29', '2025-11-23')) { p.ahs_dim=4.51; p.ahs_weight=4.51; p.oversize=49.16; }
        else if (inRange('2025-11-24', '2025-12-28')) { p.ahs_dim=5.95; p.ahs_weight=5.95; p.oversize=59.26; }
        else if (inRange('2025-12-29', '2026-01-18')) { p.ahs_dim=4.51; p.ahs_weight=4.51; p.oversize=49.16; }
        
        if (inRange('2025-10-27', '2025-11-23')) p.residential=0.44;
        else if (inRange('2025-11-24', '2025-12-28')) p.residential=0.71;
        else if (inRange('2025-12-29', '2026-01-18')) p.residential=0.44;
        return p;
    }

    function getSettings() {
        return {
            date: document.getElementById('calcDate').value,
            addrType: document.getElementById('addrType').value,
            fuelRate: parseFloat(document.getElementById('fuelRate').value) / 100,
            fuelDiscount: parseFloat(document.getElementById('fuelDiscount').value),
            dimDivisor: parseFloat(document.getElementById('dimDivisor').value),
            feeResi: parseFloat(document.getElementById('feeResi').value),
            feeAHS_Dim: parseFloat(document.getElementById('feeAHS_Dim').value),
            feeAHS_Wgt: parseFloat(document.getElementById('feeAHS_Wgt').value),
            feeOS: parseFloat(document.getElementById('feeOS').value),
            feeUnauth: parseFloat(document.getElementById('feeUnauthorized').value)
        };
    }

    function calculateLogic(sku, cmL, cmW, cmH, kg, s) {
        // 1. Dimensions & Weights
        // FIXED: Use Math.ceil for dimensions per user request "å‘ä¸Šå–æ•´"
        let dims = [cmL/2.54, cmW/2.54, cmH/2.54].sort((a,b)=>b-a);
        const len = Math.ceil(dims[0]);
        const width = Math.ceil(dims[1]);
        const height = Math.ceil(dims[2]);
        
        const weightActualRaw = kg * 2.20462;
        const weightActual = Math.ceil(weightActualRaw);
        
        const dimWeightRaw = (len * width * height) / s.dimDivisor;
        const dimWeight = Math.ceil(dimWeightRaw); // Weight always rounds up
        
        // Billing Weight is max of Actual vs Dim, but AHS-Dim has floor of 40lb, OS floor of 90lb.
        // We set initial rated weight here, adjust later for minimum billables
        let ratedWeight = Math.max(weightActual, dimWeight);

        // 2. Flags Calculation
        const girth = len + 2*width + 2*height;
        let isUnauth = false, isOS = false, isAHSDim = false, isAHSWgt = false;

        // Condition Checks
        // Unauth: > 108 length OR > 165 girth OR > 150 lbs
        if (len > 108 || girth > 165 || weightActual > 150) {
            isUnauth = true;
        }
        
        // Oversize: > 96 length OR > 130 girth (Only if not Unauth)
        if (!isUnauth && (len > 96 || girth > 130)) {
            isOS = true;
        }

        // AHS Logic: Only check if NOT Unauth and NOT Oversize (Priority Rule)
        if (!isUnauth && !isOS) {
            // Check potential triggers first
            let triggersAHSDim = (len > 48 || dims[1] > 30);
            let triggersAHSWgt = (weightActual > 50);

            if (triggersAHSDim && triggersAHSWgt) {
                // FIXED LOGIC: If both trigger, only apply the HIGHER fee
                if (s.feeAHS_Wgt >= s.feeAHS_Dim) {
                    isAHSWgt = true;
                    isAHSDim = false; // Ignore Dim
                } else {
                    isAHSDim = true;
                    isAHSWgt = false; // Ignore Wgt
                }
            } else {
                // Standard logic
                isAHSDim = triggersAHSDim;
                isAHSWgt = triggersAHSWgt;
            }
        }

        // 3. Minimum Billable Weight Adjustments
        if (isOS) {
            if (ratedWeight < 90) ratedWeight = 90;
        } else if (isAHSDim) {
             if (ratedWeight < 40) ratedWeight = 40; 
        }

        const peak = getPeakSurcharges(s.date);
        const fuelRateEffective = s.fuelRate * s.fuelDiscount;
        const fuelDisplayPct = (fuelRateEffective * 100).toFixed(3) + '%';

        const calcZone = (zKey) => {
            let base = 0;
            const w = ratedWeight > 150 ? 150 : ratedWeight;
            if (baseRates[w]) base = baseRates[w][zKey] || 0;

            let subtotal = base; 
            let details = [{n:`<span class="badge badge-fedex">Base</span> ${ratedWeight}lb`, v:base}];

            if (s.addrType === 'residential') {
                subtotal += s.feeResi;
                details.push({n:'<span class="badge badge-fedex">Resi</span>', v:s.feeResi});
                if (peak.residential > 0) { 
                    subtotal+=peak.residential; 
                    details.push({n:'<span class="badge badge-org">Pk-Resi</span>', v:peak.residential}); 
                }
            }

            // --- Priority Charging Logic ---
            if (isUnauth) {
                // Priority 1: Unauthorized
                subtotal += s.feeUnauth;
                details.push({n:'<span class="badge badge-red">Unauth</span>', v:s.feeUnauth});
                if(peak.oversize > 0) { // Unauth often triggers OS peak in system
                     subtotal += 535.29; 
                     details.push({n:'<span class="badge badge-red">Pk-Unauth</span>', v:535.29}); 
                }
            } else if (isOS) {
                // Priority 2: Oversize (Exclusive of AHS)
                subtotal += s.feeOS;
                details.push({n:'<span class="badge badge-org">OS</span> Oversize', v:s.feeOS});
                if(peak.oversize > 0) { 
                    subtotal += peak.oversize; 
                    details.push({n:'<span class="badge badge-org">Pk-OS</span>', v:peak.oversize}); 
                }
            } else {
                // Priority 3: AHS (Comparison Logic Applied Above)
                if (isAHSDim) {
                    subtotal += s.feeAHS_Dim;
                    details.push({n:'<span class="badge badge-org">AHS</span> Dim', v:s.feeAHS_Dim});
                    if(peak.ahs_dim > 0) { 
                        subtotal += peak.ahs_dim; 
                        details.push({n:'<span class="badge badge-org">Pk-AHS</span>', v:peak.ahs_dim}); 
                    }
                }
                if (isAHSWgt) {
                    subtotal += s.feeAHS_Wgt;
                    details.push({n:'<span class="badge badge-org">AHS</span> Wgt', v:s.feeAHS_Wgt});
                    
                    // Only add Peak AHS if not already added by Dim (since logic above makes them mutually exclusive if both present)
                    // If we have AHS Wgt here, it means it was the winner or the only one.
                    // Check logic ensures we don't have Pk-AHS already.
                    if (peak.ahs_weight > 0) {
                        subtotal += peak.ahs_weight;
                        details.push({n:'<span class="badge badge-org">Pk-AHS</span>', v:peak.ahs_weight});
                    }
                }
            }

            const fuelFeeRaw = subtotal * fuelRateEffective;
            const fuelFeeRounded = Math.round(fuelFeeRaw * 100) / 100; 
            details.push({n:`<span class="badge badge-fuel">Fuel</span> <small>${fuelDisplayPct}</small>`, v:fuelFeeRounded, t:'fuel-row'});
            
            return { total: subtotal + fuelFeeRounded, details: details };
        };

        const z5 = calcZone('z5');
        const z6 = calcZone('z6');
        const avgRaw = (z5.total + z6.total) / 2;
        const avgRounded = Math.round(avgRaw * 100) / 100;

        return { 
            sku, len, width, height, girth, 
            weightActual, dimWeight, ratedWeight, 
            z5, z6, avg: avgRounded, 
            isUnauth, isOS, isAHSDim, isAHSWgt 
        };
    }

    function runSingleCalc() {
        const s=getSettings();
        const sku=document.getElementById('singleSku').value || 'N/A';
        const L=parseFloat(document.getElementById('lengthCm').value)||0;
        const W=parseFloat(document.getElementById('widthCm').value)||0;
        const H=parseFloat(document.getElementById('heightCm').value)||0;
        const K=parseFloat(document.getElementById('weightKg').value)||0;
        if(!L||!K) { alert("è¯·è¾“å…¥é•¿å®½é«˜å’Œé‡é‡"); return; }

        const r = calculateLogic(sku, L, W, H, K, s);
        
        document.getElementById('singleResults').style.display='grid';
        
        // Revised layout: Flex container for horizontal display of weights
        let infoHtml = `
            <div style="display:flex; gap:15px; width:100%; margin-bottom:15px; flex-wrap:nowrap;">
                <div class="weight-box" style="flex:1">
                    <span>ä½“ç§¯é‡ (Dim)</span>
                    <strong>${r.dimWeight} lb</strong>
                </div>
                <div class="weight-box" style="flex:1">
                    <span>å®é™…é‡ (Act)</span>
                    <strong>${r.weightActual} lb</strong>
                </div>
                <div class="weight-box" style="flex:1; border-color:var(--secondary); background:#fff5eb;">
                    <span>è®¡è´¹é‡ (Bill)</span>
                    <strong>${r.ratedWeight} lb</strong>
                </div>
            </div>
            
            <div class="weight-box" style="text-align:left; padding:10px; width:100%; box-sizing:border-box;">
                <span style="display:inline-block; margin-right:10px;">ğŸ“ å°ºå¯¸: ${r.len}x${r.width}x${r.height}"</span>
                <span style="display:inline-block;">â­• å›´é•¿: ${r.girth}"</span>
                <div style="margin-top:5px;">
                    ${r.isUnauth ? '<span class="badge badge-red">ğŸš« Unauthorized</span>' : ''}
                    ${r.isOS ? '<span class="badge badge-org">ğŸ“¦ Oversize</span>' : ''}
                    ${r.isAHSDim ? '<span class="badge badge-org">âš ï¸ AHS-Dim</span>' : ''}
                    ${r.isAHSWgt ? '<span class="badge badge-org">âš–ï¸ AHS-Wgt</span>' : ''}
                </div>
            </div>
        `;
        const infoBar = document.getElementById('calcInfo');
        infoBar.innerHTML = infoHtml;
        infoBar.style.display='block'; // Changed from grid to block to support internal flex layout

        const render = (res, tId, lId) => {
            document.getElementById(tId).innerText = '$' + res.total.toFixed(2);
            let h = '';
            res.details.forEach(d => h += `<div class="detail-row${d.t?' '+d.t:''}"><span>${d.n}</span><span>$${d.v.toFixed(2)}</span></div>`);
            document.getElementById(lId).innerHTML = h;
        };
        render(r.z5, 'totalZ5', 'detailsZ5');
        render(r.z6, 'totalZ6', 'detailsZ6');
        document.getElementById('totalAvg').innerText = '$' + r.avg.toFixed(2);
    }

    function runBatchCalc() {
        const raw=document.getElementById('batchInput').value.trim();
        if(!raw) { alert("è¯·ç²˜è´´æ•°æ®"); return; }
        const s=getSettings();
        const tbody=document.getElementById('batchTableBody');
        tbody.innerHTML='';

        raw.split('\n').forEach(row => {
            const c=row.split(/\t|,/);
            if(c.length<5) return;
            const sku=c[0], L=parseFloat(c[1]), W=parseFloat(c[2]), H=parseFloat(c[3]), K=parseFloat(c[4]);
            if(!L||!K) return;

            const r = calculateLogic(sku, L, W, H, K, s);
            
            // Generate Tags
            let tags = '';
            if(r.isUnauth) tags += '<span class="badge badge-red">Unauth</span>';
            else if(r.isOS) tags += '<span class="badge badge-org">OS</span>';
            else {
                if(r.isAHSDim) tags += '<span class="badge badge-org">AHS-D</span>';
                if(r.isAHSWgt) tags += '<span class="badge badge-org">AHS-W</span>';
            }
            if(r.z6.details.some(d=>d.n.includes('Pk'))) tags += '<span class="badge badge-fedex">Peak</span>';
            
            // Detailed Surcharges for table
            let surs = r.z6.details.filter(d=>!d.n.includes('Base') && !d.n.includes('Fuel')).map(d=> {
                let cleanName = d.n.replace(/<[^>]*>?/gm, ''); 
                return `${cleanName}:$${d.v.toFixed(1)}`;
            }).join(' ');

            tbody.innerHTML += `<tr>
                <td><strong>${sku}</strong></td>
                <td>${r.len}x${r.width}x${r.height}"<br><span style="color:#999">å›´${r.girth}</span></td>
                <td>${r.ratedWeight}</td>
                <td>$${r.z5.total.toFixed(2)}</td>
                <td>$${r.z6.total.toFixed(2)}</td>
                <td style="color:var(--primary);font-weight:bold">$${r.avg.toFixed(2)}</td>
                <td>${tags}<br><span style="font-size:10px;color:#666">${surs}</span></td>
            </tr>`;
        });
    }

    function exportTableToCSV() {
        const rows = Array.from(document.querySelectorAll("#batchResultsTable tr"));
        let csv = "data:text/csv;charset=utf-8,\uFEFF";
        rows.forEach(r => {
            const cols = Array.from(r.querySelectorAll("th,td")).map(c => {
                return c.innerText.replace(/(\r\n|\n)/g," ").replace(/,/g,"").trim();
            });
            csv += cols.join(",") + "\r\n";
        });
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = "FedEx_Calc_Result.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    initSystem();
</script>
</body>
</html>